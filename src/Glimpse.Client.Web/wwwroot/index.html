<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Welcome to ASP.NET 5</title>
    <style>
    </style>
</head>
<body>


    <script src="./scripts/jquery/jquery-2.1.1.js"></script>
    <script src="./scripts/signalr/jquery.signalR-2.1.2.js"></script>
    <script src="./scripts/reactjs/react.js"></script>
    <script src="./scripts/reactjs/JSXTransformer.js"></script>
    <script>
        var messageApp = (function () {
            var repository = (function () {
                    var messages = [],
                        sortMessages = function compare(a, b) {
                            if (a.timeServer < b.timeServer) { return -1; }
                            if (a.timeServer > b.timeServer) { return 1; }
                            return 0;
                        },
                        process = function(data) {
                            data.Message = JSON.parse(data.Message);

                            var message = data.Message;
                            if (message.time) {
                                message.timeServer = message.time;
                                message.time = new Date(message.time);
                            }
                        };

                    return {
                        insert: function (data) {
                            process(data);
                            messages.push(data);
                            messages.sort(sortMessages);
                        }
                    }
                })();


            return {
                recieveMessage: function(data) {
                    repository.insert(data);
                }
            }
        })();
    </script>
    <script type="text/jsx">
    </script>
    <script>
        var connection = $.hubConnection("http://localhost:15999/glimpse/stream", { useDefaultPath: false });
        var messageClientPublisherHubProxy = connection.createHubProxy('remoteStreamMessageClientPublisherResource');
        messageClientPublisherHubProxy.on('recieveMessage', function (message) {
            messageApp.recieveMessage(message);
        });
        connection.start({ withCredentials: false })
            .done(function () { console.log('Now connected, connection ID=' + connection.id); })
            .fail(function () { console.log('Could not connect'); });
    </script>
</body>
</html>