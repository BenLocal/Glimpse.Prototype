<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Welcome to ASP.NET 5</title>
    <style>
        body {
            background-color: #1E1E1E;
            color: white;
        }
        .message-application th, .message-application td {
            text-align: left;
        }
        .request-item { 
            width: 100%;
        } 
        .request-item-header {
            font-weight: bold;
            height: 20px;
        }
        .request-item-title {
            font-size: 140%;
            width: 50%;
            float: left;
        }
        .request-item-id {
            float: right;
        }
        .message-item {
            width: 100%;
        }
        .request-item-messages {
            margin: 10px 0 30px;
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <script src="./scripts/jquery/jquery-2.1.1.js"></script>
    <script src="./scripts/signalr/jquery.signalR-2.1.2.js"></script>
    <script src="./scripts/reactjs/react.js"></script>
    <script src="./scripts/reactjs/JSXTransformer.js"></script>

    <script type="text/jsx">

        var MessagesItem = React.createClass({
                render: function() {
                    var message = this.props.message,
                        payload = message.payload;

                    return (
                            <table className="message-item">
                                <tr>
                                    <th>{message.type}</th>
                                    <td>{payload.timeServer}</td>
                                    <td>{payload.id}</td>
                                </tr>
                            </table>
                        );
                }
            });
        
        var MessagesList = React.createClass({
                render: function() {
                    var messages = this.props.messages;
        
                    return (
                            <div className="request-item-messages">
                                {messages.map(function(message) {
                                    var payload = message.payload;

                                    return <MessagesItem key={payload.id} message={message} />;
                                })}
                            </div>
                        );
                }
            });
        
        var RequestItem = React.createClass({
                render: function() {
                    var request = this.props.request,
                        messages = request.messages;

                    return (
                            <div className="request-item">
                                <div className="request-item-header">
                                    <div className="request-item-title">{request.uri}</div>
                                    <div className="request-item-id">{request.id}</div>
                                </div> 
                                <MessagesList messages={messages} />
                            </div>
                        );
                }
            });
        
        var RequestList = React.createClass({
                render: function() {
                    var requests = this.props.requests,
                        items = {};

                    for (var key in requests) {
                        var request = requests[key];
                        items[request.id] = <RequestItem request={request} />
                    }
        
                    return  <div>{items}</div>;
                }
            });
        
        var MessageApplication = React.createClass({
                render: function() {
                    var messages = this.props.messages,
                        requests = this.props.requests;

                    return (
                            <div className="message-application">
                                <h1>Glimpse Client</h1>
                                Shows a list of messages that are being recieved by the client:

                                <h2>Request</h2>
                                <RequestList requests={requests} />

                                <h2>Messages</h2>
                                <MessagesList messages={messages} />
                            </div>
                        );
                }
            });
    </script>
    <script>
        var messageApp = (function () {
            var repository = (function () {
                    var messages = [],
                        requests = {},
                        sortMessages = function compare(a, b) { 
                            if (a.payload.timeLong < b.payload.timeLong) { return -1; }
                            if (a.payload.timeLong > b.payload.timeLong) { return 1; }
                            return 0;
                        },
                        processMessage = function (message) {
                            message.type = message.Type;
                            delete message.Type;

                            message.payload = message.Payload;
                            delete message.Payload;

                            message.payload = JSON.parse(message.payload);

                            var payload = message.payload;
                            if (payload.time) {
                                payload.timeServer = payload.time;
                                payload.time = new Date(payload.time);
                            }

                            messages.push(message);
                            messages.sort(sortMessages);
                        },
                        processRequest = function(message) {
                            var payload = message.payload,
                                request = requests[payload.requestId];

                            if (!request) {
                                request = {
                                        uri: payload.uri,
                                        id: payload.requestId,
                                        messages: []
                                    };

                                requests[payload.requestId] = request;
                            }

                            request.messages.push(message);
                            request.messages.sort(sortMessages);
                        };

                    return {
                        insert: function (data) {
                            processMessage(data);
                            processRequest(data);

                            return { messages: messages, requests: requests };
                        }
                    }
                })();


            return {
                recieveMessage: function(data) {
                    var result = repository.insert(data);
                     
                    React.render(
                        MessageApplication(result),
                        document.getElementById('container')
                    );
                }
            }
        })();
    </script>
    <script>
        var connection = $.hubConnection("http://localhost:15999/glimpse/stream", { useDefaultPath: false });
        var messageClientPublisherHubProxy = connection.createHubProxy('remoteStreamMessageClientPublisherResource');
        messageClientPublisherHubProxy.on('recieveMessage', function (message) {
            messageApp.recieveMessage(message);
        });
        connection.start({ withCredentials: false })
            .done(function () { console.log('Now connected, connection ID=' + connection.id); })
            .fail(function () { console.log('Could not connect'); });
    </script>
</body>
</html>